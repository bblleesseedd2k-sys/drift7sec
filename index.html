<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drift Countdown Animation</title>
<!-- üîπ –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç -->
<link href="https://fonts.googleapis.com/css?family=Kdam+Thmor&display=swap" rel="stylesheet">
<style>
  html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    font-family: "Kdam Thmor", system-ui, sans-serif;
  }
  /* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ */
  #captureZone {
    position: relative;
    width: 1280px;
    height: 629px;
    background: url("background.jpg") center/cover no-repeat;
    transform-origin: top center;
  }
  /* –ú–∞—Å—à—Ç–∞–± –ø–æ–¥ —ç–∫—Ä–∞–Ω */
  @media (min-aspect-ratio: 1280/629) {
    #captureZone { transform: scale(calc(100vh / 629)); }
  }
  @media (max-aspect-ratio: 1280/629) {
    #captureZone { transform: scale(calc(100vw / 1280)); }
  }
  .warning-area {
    position: absolute;
    top: 100px; left: 415px;
    width: 600px; text-align: center;
    color: white;
  }
  .warning-area h1 {
    color: #e64a4a;
    font-size: 58px;
    margin-bottom: 2px;
  }
  .warning-area .sub {
    font-size: 40px;
    margin-bottom: 2px;
  }
  .timer {
    font-size: 58px;
    font-weight: 400;
    color: #e64a4a;
  }
  .phone {
    position: absolute;
    top: 441px; left: 625px;
    font-size: 24px; font-weight: 400;
    color: black;
    letter-spacing: 1px;
  }
  .amounts {
    position: absolute;
    top: 520px;
    left: 56%;
    transform: translateX(-50%);
    font-size: 24px;
    color: white;
    text-align: center;
    white-space: nowrap;
  }
  .username {
    position: absolute;
    bottom: 20px; left: 62px;
    color: #ccc;
    font-size: 18px;
  }
  /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
  .controls {
    position: fixed;
    bottom: 10px; right: 10px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 20;
  }
  .controls label { display: block; margin-top: 6px; }
  .controls input {
    width: 200px; padding: 4px 6px; margin-top: 2px;
    border-radius: 4px; border: none;
  }
  .controls button {
    margin-top: 10px; background: #e64a4a; color: #fff; border: none;
    padding: 8px 10px; border-radius: 6px; cursor: pointer; font-weight: 400;
  }
  .controls button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  /* Canvas –¥–ª—è –∑–∞–ø–∏—Å–∏ - —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–Ω –Ω–æ —Å–∫—Ä—ã—Ç –∑–∞ —Å—Ü–µ–Ω–æ–π */
  #renderCanvas {
    position: fixed;
    top: -10000px;
    left: -10000px;
  }
  
  /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
  #progress {
    display: none;
    margin-top: 10px;
    padding: 8px;
    background: rgba(0,0,0,0.8);
    border-radius: 6px;
    font-size: 13px;
  }
  #progressBar {
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 6px;
  }
  #progressFill {
    height: 100%;
    background: #e64a4a;
    width: 0%;
    transition: width 0.3s;
  }
</style>
</head>
<body>
  <div id="captureZone">
    <div class="warning-area">
      <h1>WARNING</h1>
      <div class="sub">PROFIT WILL BE CANCELLED IN</div>
      <div class="timer" id="timer">12:00:00</div>
    </div>
    <div class="phone" id="phone">01145852502</div>
    <div class="amounts">
      THE AMOUNT TO BE PAID IS <span id="amount1">24,899</span> EGP<br>
      TO THE CONCLUSION: <span id="amount2">248,099.08</span> EGP
    </div>
    <div class="username" id="username">Yara Mohamed</div>
  </div>
  
  <div class="controls" id="controls">
    <label>‚è± –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (HH:MM:SS): <input id="inputTimer" type="text" value="12:00:00"></label>
    <label>üìû –ù–æ–º–µ—Ä: <input id="inputPhone" type="text" value="01145852502"></label>
    <label>üí∞ –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: <input id="inputAmt1" type="text" value="24,899"></label>
    <label>üìà –°—É–º–º–∞ –ø—Ä–∏–±—ã–ª–∏: <input id="inputAmt2" type="text" value="248,099.08"></label>
    <label>üë§ –ò–º—è: <input id="inputName" type="text" value="Yara Mohamed"></label>
    <label>üé¨ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ (—Å–µ–∫): <input id="inputDuration" type="number" value="7" min="1" max="60"></label>
    <button onclick="applyData()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <button onclick="startCountdown()">Start</button>
    <button id="recordBtn" onclick="recordVideo()">üé• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–¥–µ–æ</button>
    
    <div id="progress">
      <div id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>
  </div>
  
  <canvas id="renderCanvas"></canvas>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
  
  <script>
  let countdown = 0;
  let timerInterval = null;
  let ffmpeg = null;
  
  function pad(n){return n.toString().padStart(2,"0");}
  
  function fmt(s){
    if(s<0) s=0;
    const h=Math.floor(s/3600);
    const m=Math.floor((s%3600)/60);
    const sec=s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  }
  
  function parseHMS(str){
    const parts=str.trim().split(":");
    if(parts.length!==3) return null;
    const[h,m,s]=parts.map(Number);
    if([h,m,s].some(n=>isNaN(n)||n<0)) return null;
    return h*3600+m*60+s;
  }
  
  function updateTimer(){
    document.getElementById("timer").textContent=fmt(countdown);
  }
  
  function startCountdown(limitSeconds=null){
    clearInterval(timerInterval);
    const total=parseHMS(document.getElementById("inputTimer").value);
    if(total===null){
      alert("–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS, –Ω–∞–ø—Ä–∏–º–µ—Ä 12:00:00");
      return;
    }
    countdown=total;
    updateTimer();
    let ticks=0;
    timerInterval=setInterval(()=>{
      countdown--;
      updateTimer();
      if(limitSeconds!==null){
        ticks++;
        if(ticks>=limitSeconds) clearInterval(timerInterval);
      }
    },1000);
  }
  
  function applyData(){
    document.getElementById("phone").textContent=document.getElementById("inputPhone").value;
    document.getElementById("amount1").textContent=document.getElementById("inputAmt1").value;
    document.getElementById("amount2").textContent=document.getElementById("inputAmt2").value;
    document.getElementById("username").textContent=document.getElementById("inputName").value;
    const val=document.getElementById("inputTimer").value.trim();
    const s=parseHMS(val);
    document.getElementById("timer").textContent=s!==null?fmt(s):val;
  }
  
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("inputTimer").addEventListener("input",applyData);
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FFmpeg
  async function initFFmpeg() {
    if (ffmpeg) return ffmpeg;
    
    const { FFmpeg } = FFmpegWASM;
    ffmpeg = new FFmpeg();
    
    ffmpeg.on("log", ({ message }) => {
      console.log(message);
    });
    
    ffmpeg.on("progress", ({ progress }) => {
      const percent = Math.round(progress * 100);
      updateProgress(`–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP4: ${percent}%`, 50 + percent / 2);
    });
    
    updateProgress("–ó–∞–≥—Ä—É–∑–∫–∞ FFmpeg...", 0);
    
    await ffmpeg.load({
      coreURL: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js",
      wasmURL: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm"
    });
    
    return ffmpeg;
  }
  
  function updateProgress(text, percent) {
    const progressDiv = document.getElementById("progress");
    const progressText = document.getElementById("progressText");
    const progressFill = document.getElementById("progressFill");
    
    progressDiv.style.display = "block";
    progressText.textContent = text;
    progressFill.style.width = percent + "%";
  }
  
  function hideProgress() {
    document.getElementById("progress").style.display = "none";
  }
  
  async function recordVideo(){
    const recordBtn = document.getElementById("recordBtn");
    recordBtn.disabled = true;
    recordBtn.textContent = "‚è≥ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...";
    
    let duration = parseInt(document.getElementById("inputDuration").value) || 7;
    duration = Math.min(Math.max(duration,1),60);
    const userName = (document.getElementById("inputName").value.trim().replace(/\s+/g,"_")) || "User";
    const total = parseHMS(document.getElementById("inputTimer").value);
    
    if(total===null){
      alert("–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS, –Ω–∞–ø—Ä–∏–º–µ—Ä 12:00:00");
      recordBtn.disabled = false;
      recordBtn.textContent = "üé• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–¥–µ–æ";
      return;
    }
    
    countdown = total;
    updateTimer();
    
    updateProgress("–°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞ —ç–∫—Ä–∞–Ω–∞...", 5);
    
    // –°–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω snapshot —Å html2canvas
    const capture = document.getElementById("captureZone");
    const snapshot = await html2canvas(capture, {
      backgroundColor: null,
      useCORS: true,
      scale: 1,
      width: 1280,
      height: 629
    });
    
    // –°–æ–∑–¥–∞—ë–º canvas –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    const canvas = document.getElementById("renderCanvas");
    canvas.width = 1280;
    canvas.height = 629;
    const ctx = canvas.getContext("2d", { alpha: false });
    
    updateProgress("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...", 10);
    
    // –°–æ–∑–¥–∞—ë–º stream —Å canvas (30 FPS)
    const stream = canvas.captureStream(30);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏—Ö—É—é –∞—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫—É
    const audioCtx = new AudioContext();
    const dest = audioCtx.createMediaStreamDestination();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.001; // –û—á–µ–Ω—å —Ç–∏—Ö–∏–π –∑–≤—É–∫
    osc.connect(gain).connect(dest);
    osc.start();
    
    const combinedStream = new MediaStream([
      ...stream.getVideoTracks(),
      ...dest.stream.getAudioTracks()
    ]);
    
    // Recorder —Å –±–∏—Ç—Ä–µ–π—Ç–æ–º –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
    const recorder = new MediaRecorder(combinedStream, {
      mimeType: "video/webm;codecs=vp8,opus",
      videoBitsPerSecond: 5000000 // 5 Mbps
    });
    
    const chunks = [];
    recorder.ondataavailable = e => {
      if (e.data.size > 0) {
        chunks.push(e.data);
      }
    };
    
    recorder.onstop = async () => {
      updateProgress("–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ...", 40);
      
      const webmBlob = new Blob(chunks, {type: "video/webm"});
      
      try {
        const { fetchFile } = FFmpegUtil;
        const ffmpegInstance = await initFFmpeg();
        
        updateProgress("–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏...", 45);
        await ffmpegInstance.writeFile("input.webm", await fetchFile(webmBlob));
        
        updateProgress("–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP4...", 50);
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è Telegram
        await ffmpegInstance.exec([
          "-i", "input.webm",
          "-c:v", "libx264",
          "-profile:v", "baseline",    // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
          "-level", "3.0",
          "-preset", "medium",
          "-crf", "23",
          "-pix_fmt", "yuv420p",       // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          "-c:a", "aac",
          "-b:a", "128k",
          "-ar", "44100",              // Sample rate
          "-movflags", "+faststart",    // –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
          "-r", "30",                  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π FPS
          "output.mp4"
        ]);
        
        updateProgress("–ü–æ–ª—É—á–µ–Ω–∏–µ MP4 —Ñ–∞–π–ª–∞...", 95);
        
        const mp4Data = await ffmpegInstance.readFile("output.mp4");
        const mp4Blob = new Blob([mp4Data.buffer], {type: "video/mp4"});
        
        await ffmpegInstance.deleteFile("input.webm");
        await ffmpegInstance.deleteFile("output.mp4");
        
        const url = URL.createObjectURL(mp4Blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `drift_countdown_${userName}_${duration}s.mp4`;
        a.click();
        URL.revokeObjectURL(url);
        
        updateProgress("–ì–æ—Ç–æ–≤–æ! ‚úÖ", 100);
        setTimeout(hideProgress, 2000);
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:", error);
        hideProgress();
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ MP4: " + error.message);
      }
      
      recordBtn.disabled = false;
      recordBtn.textContent = "üé• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–¥–µ–æ";
      osc.stop();
      audioCtx.close();
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
    recorder.start(100); // –ß–∞–Ω–∫–∏ –ø–æ 100–º—Å
    updateProgress("–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ...", 15);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    startCountdown(duration);
    
    const startTime = Date.now();
    const endTime = startTime + duration * 1000;
    const fps = 30;
    const frameDelay = 1000 / fps;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º FPS
    function renderFrame() {
      const now = Date.now();
      const elapsed = now - startTime;
      
      // –†–∏—Å—É–µ–º –±–∞–∑–æ–≤—ã–π snapshot
      ctx.drawImage(snapshot, 0, 0, 1280, 629);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ canvas
      ctx.font = '58px "Kdam Thmor", sans-serif';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#e64a4a';
      
      // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞
      ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.fillRect(415, 200, 600, 80);
      
      // –†–∏—Å—É–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
      ctx.fillStyle = '#e64a4a';
      ctx.fillText(fmt(countdown), 715, 260);
      
      const percent = Math.min((elapsed / (duration * 1000)) * 25, 25);
      updateProgress(`–ó–∞–ø–∏—Å—å: ${Math.round(elapsed/1000)}/${duration} —Å–µ–∫`, 15 + percent);
      
      if (now < endTime) {
        setTimeout(renderFrame, frameDelay);
      } else {
        setTimeout(() => {
          recorder.stop();
        }, 500);
      }
    }
    
    renderFrame();
  }
  </script>
</body>
</html>
